![배너.png](/ReadMeSource/배너.png)

- 태그: 3인칭, 멀티플레이어
- 사용 프로그램: Unreal Engine 5, VisualStudio 2022, Github, Notion
- 팀 구성: 프로그래머 1인 개발
- 플랫폼: PC
- 작업 기간: 2024년 4월 → 2024년 8월 초
<br>


## ❗개요 및 주의사항
- **Unreal Engine 5를 사용한 PC(Windows) 기반 3인칭 멀티플레이 슈팅 게임.**
- 총을 쏘는 것이 아닌, 폭탄을 던져서 적을 제거하고 점수를 얻어 승리하는 게임입니다.
- Unreal Engine 5의 기본 프레임워크와 멀티플레이 메커니즘 경험을 목표로 삼았으며, 대부분의 기능은 C++을 이용해 제작했습니다.

<br>


## 🖥️ 개발 내용
### 게임 루프

![게임루프.png](/ReadMeSource/GameLoop.png)

 게임은 언리얼 온라인 서브시스템을 사용하여 세션 관련 기능을 처리하였으며, 리슨 서버 방식으로 작동합니다. 게임이 시작되면 메인화면-로비-본 게임-메인화면으로 루프가 반복됩니다.

- 메인화면
    - 새로운 세션을 생성하거나 다른 유저가 생성한 세션을 탐색하여 참가합니다. 이때 세션에 참가할 수 있는 최대 인원 및 LAN 사용 여부를 선택할 수 있습니다.
- 로비
    - 세션을 생성하거나 세션에 참가한 유저는 로비로 이동하며, 인원에 맞추어 참가한 유저의 이름이 표시된 캐릭터가 나타납니다.
    - 로비에서는 게임 준비 / 메인화면으로 나가기를 선택할 수 있습니다. 클라이언트의 준비 신호는 서버로 전송되며, 모든 인원이 준비되었을 때 본 게임으로 서버 트래블을 진행합니다.
    - 총인원 대비 준비된 인원수가 동기화되어 로비 상단 UI에 표시됩니다.
- 본 게임
    - 게임에 참여한 각 유저는 서버트래블 및 로딩을 마친 후 서버에 준비 신호를 전달합니다. 모든 인원이 준비되었을 때 매치를 시작하며, 점수판이 활성화됩니다.
    - 각 유저는 일정 시간 후 폭발하는 폭탄을 던져 데미지를 입힐 수 있습니다. 감소된 체력은 맵 곳곳에 존재하는 아이템을 사용하여 회복할 수 있으며, 모든 체력을 소진하여 사망한 플레이어는 지정 스폰 포인트 중 한 곳에 랜덤하게 리스폰 됩니다.
- 지정된 매치 시간이 만료되거나 지정 점수를 달성한 유저가 나타났을 때, 매치를 종료하고 점수판을 표시합니다.

<br>


### 폭탄 시스템

![폭탄매니저.png](/ReadMeSource/bomb_manager_bg.png)

 초기에는 단일 폭탄을 사용하여 장전 시점에 이를 소켓에 장착하고, 던지는 시점에 분리하는 방식을 사용했었습니다. 이는 시각적으로 자연스러웠지만, 매번 물리 설정을 변경해야 한다는 단점이 있었습니다. 그렇기에 두 종류의 폭탄을 구분하여 사용합니다.

- 폭탄은 캐릭터가 손에 들고 있는 폭탄과 오브젝트 풀에 저장된 폭탄으로 구분됩니다.
    - 손에 들고 있는 폭탄은 캐릭터의 소켓에 고정되어 있습니다. 던지는 시점에 모습을 숨기고, 재장전 시점에 모습을 다시 드러냅니다.
    - 오브젝트 풀에 있는 폭탄들은 서버의 폭탄 매니저에 의해 관리됩니다. 폭탄 매니저는 주어진 종류의 폭탄을 생성하고 관리하며, 캐릭터의 요청에 따라 비활성화 상태인 폭탄을 활성화하여 전달합니다. 폭탄의 폭발 트리거를 발동하는 역할 또한 맡습니다.
- 폭탄은 활성화 / 비활성화 상태 변경이 가능합니다.
    - 함수 호출에 따라 가시성과 틱, 물리 연산에 관한 활성화 여부가 변경됩니다. 오브젝트 풀에서 대기하는 동안에는 비활성 상태를 유지합니다.
    - 폭탄 매니저에 의해 트리거가 활성화되면 지정 시간 이후 폭발합니다. 이때 범위 내의 대상에게 피해를 입히고 이펙트를 재생합니다. 폭발 이후에는 비활성화 상태로 변경됩니다.
- 클라이언트 플레이어의 폭탄 던지기 입력은 서버 RPC를 통해 전달됩니다. 서버는 프로퍼티 리플리케이션을 통해 모든 클라이언트에게 해당 정보를 전달합니다. 조준 여부 또한 동일한 과정을 거쳐 전달됩니다.
- 던지기 또는 조준 신호를 전달받으면 서버와 클라이언트를 구분하여 동작을 수행합니다.
    - 클라이언트 - 몽타주 재생 / UI 표시 / 폭발 이펙트 재생
    - 서버 - 폭탄 차징 / 폭탄 던지기 / 폭발 데미지 처리
    
     던지기 몽타주가 재생되고 AnimNotify가 호출되었을 때, 폭탄에 힘을 가해 던지는 동작이 수행됩니다. 이때 오브젝트 풀에 있던 폭탄이 활성화되어 손에 들고 있는 폭탄의 위치로 이동합니다. 캐릭터 메쉬의 `EVisibilityBasedAnimTickOption`을 `AlwaysTickPoseAndRefreshBones`로 지정하여, 클라이언트 플레이어가 서버 플레이어의 시야에서 벗어난 경우에도 본과 소켓의 위치가 갱신되도록 했습니다. 이를 통해 예상과 다른 위치에서 폭탄이 발사되는 것을 방지했습니다. 
    
- 조준하는 동안 차징 UI 표시와 타임라인을 활용한 카메라 확대 및 축소가 진행됩니다.

<br>


### 데미지 처리 시스템

![데미지 시스템.png](/ReadMeSource/damage_system.png)

- 각 플레이어 캐릭터는 스탯 컴포넌트를 보유합니다.
    - 스탯 컴포넌트는 체력 변경, 사망 처리, 사망 시 가해자와 피해자 정보 등을 전달하는 대리자를 소유하며 현재 체력의 변경과 계산을 담당합니다.
    - 본 게임에서 사용되는 스텟은 FEPCharacterStat 구조체에 정리되어 있습니다. 구조체 내부에는 HP가 존재합니다.
    - 캐릭터의 기본 스텟은 FEPCharacterStat 구조체를 열로 사용하는 UDataTable에 저장되어 있습니다. 게임 인스턴스에서 이를 로드하고, 로드된 데이터를 스탯 컴포넌트가 사용합니다.
- 데미지 적용
    - 폭탄은 서버에서 ApplyRadialDamage() 함수를 통해 범위 내의 캐릭터들에게 데미지를 전달합니다. 피해를 입은 캐릭터들의 TakeDamage() 함수가 호출되며, 스탯 컴포넌트의 체력 변경 함수가 실행됩니다.
    - 변경된 체력은 프로퍼티 리플리케이션을 통해 각 클라이언트에게 전달되며, 프로퍼티 값의 변경이 확인되었을 때 OnRep 함수에서 대리자를 호출하여 관련 기능들을 실행합니다.
- 아이템
    - 맵 곳곳에는 아이템이 존재하며, 아이템 타입과 스탯 증감 정보를 가지고 있습니다.
    - 플레이어와 오버랩되면 아이템이 사용되며 플레이어의 체력을 일정량 회복합니다.
- 데미지를 입은 플레이어는 짧은 시간 동안 카메라가 흔들립니다.

<br>


### 타이머 위젯 동기화

![타이머위젯 준비 전.png](/ReadMeSource/TimerUI_ready.png)
(아직 준비되지 않은 플레이어가 있기 때문에 타이머가 작동하지 않는다.)

![타이머위젯 준비 전.png](/ReadMeSource/TimerUI_start.png)
(모든 플레이어가 준비되었을 때, 서버와 클라이언트에서 동시에 타이머가 작동한다.)

 화면 상단에는 잔여 매치 시간을 나타내는 타이머 위젯이 있습니다. 해당 위젯은 모든 플레이어의 서버 트래블과 로딩이 완료된 이후, 매치가 시작될 때 활성화됩니다.

 위젯에 표시되는 시간 정보는 서버-클라이언트간 전송 지연 시간을 고려한 동기화를 적용했습니다.

![타이머동기화.png](/ReadMeSource/TimerWidget.png)

 클라이언트가 서버에 연결된 이후 동기화를 진행합니다. 클라이언트가 서버에 현재 시각을 전송하면, 서버는 해당 데이터와 서버의 현재 시각을 회신합니다. 클라이언트는 이를 바탕으로 RoundTripTime을 얻을 수 있습니다. 단방향 전송 지연은 RoundTripTime을 반으로 나눈 값을 사용했습니다. 서버의 현재 시각은 서버가 회신한 시점의 서버 시각에 단방향 전송 지연을 더한 값입니다. 이렇게 얻은 서버 시각과 지연 시간을 바탕으로 잔여 플레이 타임을 계산하여 위젯에 반영합니다. 

<br>


### 점수판 위젯 동기화

![스코어보드.png](/ReadMeSource/scoreboard.png)
(폭탄이 터지기 전후 점수판 위젯 비교)

 본 게임 도중 탭 버튼을 누르거나 매치가 종료되었을 때, 점수판 위젯을 확인할 수 있습니다. 점수판 위젯은 킬 카운트, 데스 카운트, 점수 정보를 나타내며, 높은 점수를 가진 플레이어부터 내림차순으로 표시합니다.

 위젯에 사용되는 정보는 플레이어 스테이트와 점수를 멤버로 가지는 FScoreBoard 구조체 배열로 관리합니다. 플레이어 스테이트에서 킬, 데스 정보를 가져와 점수 가중치를 곱해 총 점수를 계산하는 방식입니다. 이 구조체 배열은 모든 플레이어가 정렬된 점수판에 접근할 수 있도록 게임 스테이트에서 관리합니다.

 초기에는 점수를 기준으로 하는 Key-Value 쌍과 자동 정렬 특성을 고려하여 MultiMap 자료구조를 사용하고자 했습니다. 그러나 리플리케이션을 할 수 없다는 문제가 있었기에 구조체 배열 및 정렬 과정을 추가로 수행하는 방식을 선택했습니다. 

 점수판은 정보 변동 시, 프로퍼티 리플리케이션을 통해 동기화 및 갱신됩니다. 


<br>


### 캐릭터 컨트롤

- 키보드와 마우스 입력을 사용하여 플레이어 캐릭터를 조종할 수 있습니다.
- 에임 오프셋을 적용하여 마우스 움직임에 따라 시선이 이동합니다.
- 애니메이션 몽타주를 사용하여 던지기, 재장전 동작이 실행됩니다.

<br>


## 🕹️ 인게임 영상
[![포트폴리오 영상](/ReadMeSource/youtube_thumbnail_2.png)](https://youtu.be/0zBQWa4tcEE?si=OKgr1P8ftiUFI7M)
